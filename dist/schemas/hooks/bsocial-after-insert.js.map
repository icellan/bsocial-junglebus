{"version":3,"file":"bsocial-after-insert.js","names":["updateActionStats","txId","map","idKey","collection","incField","additionalKeys","tx","_id","bsv","crypto","Hash","sha256","Buffer","from","toString","existing","findOne","registerAction","t","Math","round","Date","insert","BSOCIAL","updateOne","$inc","catch","e","console","error","reason","message","bSocialAfterInsertLike","type","context","LIKES","bSocialAfterInsertRepost","REPOSTS","bSocialAfterInsertComment","COMMENTS","bSocialAfterInsertTip","TIPS","c","currency","a","amount","bSocialAfterInsertPayment","doc","BPP","address","PAYMENTS","decryptionKey","apiEndpoint","bSocialAfterInsertFollow","FOLLOWS","follows","bSocialAfterInsertUnfollow","deleteOne","bSocialAfterInsert","AIP","verified","bapId","MAP","i","length"],"sources":["../../../src/schemas/hooks/bsocial-after-insert.js"],"sourcesContent":["import bsv from 'bsv';\nimport { BSOCIAL } from '../bsocial';\nimport { LIKES } from '../likes';\nimport { COMMENTS } from '../comments';\nimport { REPOSTS } from '../reposts';\nimport { TIPS } from '../tips';\nimport { PAYMENTS } from '../payments';\nimport { FOLLOWS } from '../follows';\n\nconst updateActionStats = async function (\n  txId,\n  map,\n  idKey,\n  collection,\n  incField,\n  additionalKeys = false,\n) {\n  const { tx } = map;\n  const _id = bsv.crypto.Hash.sha256(Buffer.from(`${idKey}${tx}`)).toString('hex');\n  const existing = await collection.findOne({ _id });\n  if (!existing) {\n    let registerAction = {\n      _id,\n      txId,\n      idKey,\n      tx,\n      t: Math.round(+new Date() / 1000),\n    };\n    if (additionalKeys) {\n      registerAction = { ...registerAction, ...additionalKeys };\n    }\n    await collection.insert(registerAction);\n\n    await BSOCIAL.updateOne({\n      _id: tx,\n    }, {\n      $inc: {\n        [incField]: 1,\n      },\n    }).catch((e) => {\n      console.error('Failed updating BSocial updateActionStats', incField, e.reason || e.message);\n    });\n  }\n};\n\nconst bSocialAfterInsertLike = async function (txId, map, idKey) {\n  if (map.type === 'like' && map.context === 'tx' && map.tx) {\n    await updateActionStats(txId, map, idKey, LIKES, 'likes');\n  }\n};\n\nconst bSocialAfterInsertRepost = async function (txId, map, idKey) {\n  if (map.type === 'repost' && map.tx) {\n    await updateActionStats(txId, map, idKey, REPOSTS, 'reposts');\n  }\n};\n\nconst bSocialAfterInsertComment = async function (txId, map, idKey) {\n  if (map.type === 'post' && map.context === 'tx' && map.tx) {\n    await updateActionStats(txId, map, idKey, COMMENTS, 'comments');\n  }\n};\n\nconst bSocialAfterInsertTip = async function (txId, map, idKey) {\n  if (map.type === 'tip' && map.context === 'tx' && map.tx) {\n    await updateActionStats(txId, map, idKey, TIPS, 'tips', {\n      c: map.currency || '',\n      a: Number(map.amount) || 0,\n    });\n  }\n};\n\nconst bSocialAfterInsertPayment = async function (txId, map, doc) {\n  if (\n    map.type === 'payment'\n    && map.context === 'tx'\n    && map.tx\n    && doc.BPP\n    && doc.BPP[0]\n    && doc.BPP[0].address\n  ) {\n    const { address } = doc.BPP[0];\n    await updateActionStats(txId, map, address, PAYMENTS, 'payments', {\n      decryptionKey: doc.BPP[0].apiEndpoint, // decryption key field when PAID\n    });\n  }\n};\n\nconst bSocialAfterInsertFollow = async function (txId, map, idKey) {\n  if (map.type === 'follow' && map.idKey) {\n    const _id = bsv.crypto.Hash.sha256(Buffer.from(`${idKey}${map.idKey}`)).toString('hex');\n    const existing = await FOLLOWS.findOne({ _id });\n    if (!existing) {\n      const registerAction = {\n        _id,\n        txId,\n        idKey,\n        follows: map.idKey,\n        t: Math.round(+new Date() / 1000),\n      };\n      await FOLLOWS.insert(registerAction);\n    }\n  }\n};\n\nconst bSocialAfterInsertUnfollow = async function (txId, map, idKey) {\n  if (map.type === 'unfollow' && map.idKey) {\n    const _id = bsv.crypto.Hash.sha256(Buffer.from(`${idKey}${map.idKey}`)).toString('hex');\n    const existing = await FOLLOWS.findOne({ _id });\n    if (existing) {\n      await FOLLOWS.deleteOne({\n        idKey,\n        follows: map.idKey,\n      });\n    }\n  }\n};\n\nexport const bSocialAfterInsert = async function (doc) {\n  // spec says the first AIP should be about the social stuff\n  // second AIP should be the posting site if applicable\n  if (doc.AIP && doc.AIP[0] && doc.AIP[0].verified === true) {\n    // only process verified transactions\n    const idKey = doc.AIP[0].bapId || Buffer.from(doc.AIP[0].address).toString('hex');\n    if (doc.MAP) {\n      const txId = doc._id;\n      for (let i = 0; i < doc.MAP.length; i++) {\n        const map = doc.MAP[i];\n        if (map.type === 'like') {\n          await bSocialAfterInsertLike(txId, map, idKey);\n        } else if (map.type === 'repost') {\n          await bSocialAfterInsertRepost(txId, map, idKey);\n        } else if (map.type === 'post' && map.context === 'tx') {\n          await bSocialAfterInsertComment(txId, map, idKey);\n        } else if (map.type === 'tip' && map.context === 'tx') {\n          await bSocialAfterInsertTip(txId, map, idKey);\n        } else if (map.type === 'payment' && map.context === 'tx') {\n          await bSocialAfterInsertPayment(txId, map, doc);\n        } else if (map.type === 'follow' && map.idKey) {\n          await bSocialAfterInsertFollow(txId, map, idKey);\n        } else if (map.type === 'unfollow' && map.idKey) {\n          await bSocialAfterInsertUnfollow(txId, map, idKey);\n        }\n      }\n    }\n  }\n};\n"],"mappings":"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"}